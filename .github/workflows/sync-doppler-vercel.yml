name: Sync Doppler to Vercel

on:
  push:
    branches: [main]
  workflow_dispatch: # Allows manual triggering
  schedule:
    - cron: '0 0 * * 0' # Weekly sync (every Sunday at midnight)

jobs:
  sync-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Doppler CLI
        run: |
          curl -Ls https://cli.doppler.com/install.sh | sh
          doppler --version
      
      - name: Fetch secrets from Doppler
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_SERVICE_TOKEN }}
        run: |
          echo "Fetching secrets from Doppler..."
          doppler secrets download --no-file --format json --token="$DOPPLER_TOKEN" > doppler_secrets.json
          echo "‚úÖ Fetched $(cat doppler_secrets.json | jq 'length') secrets"
      
      - name: Install Vercel CLI
        run: npm install -g vercel@latest
      
      - name: Sync secrets to Vercel Development
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          echo "Syncing secrets to Vercel Development environment..."
          
          # Parse secrets and add to Vercel
          cat doppler_secrets.json | jq -r 'to_entries[] | 
            select(.key | startswith("DOPPLER_") | not) | 
            "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            if [ ! -z "$key" ]; then
              echo "Adding $key to Vercel Development..."
              echo "$value" | vercel env add "$key" development --force \
                --token="$VERCEL_TOKEN" 2>/dev/null || echo "‚ö†Ô∏è Failed to add $key"
            fi
          done
          
          echo "‚úÖ Sync to Development complete"
      
      - name: Sync secrets to Vercel Preview
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          echo "Syncing secrets to Vercel Preview environment..."
          
          cat doppler_secrets.json | jq -r 'to_entries[] | 
            select(.key | startswith("DOPPLER_") | not) | 
            "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            if [ ! -z "$key" ]; then
              echo "Adding $key to Vercel Preview..."
              echo "$value" | vercel env add "$key" preview --force \
                --token="$VERCEL_TOKEN" 2>/dev/null || echo "‚ö†Ô∏è Failed to add $key"
            fi
          done
          
          echo "‚úÖ Sync to Preview complete"
      
      - name: Sync secrets to Vercel Production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          echo "Syncing secrets to Vercel Production environment..."
          
          cat doppler_secrets.json | jq -r 'to_entries[] | 
            select(.key | startswith("DOPPLER_") | not) | 
            "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            if [ ! -z "$key" ]; then
              echo "Adding $key to Vercel Production..."
              echo "$value" | vercel env add "$key" production --force \
                --token="$VERCEL_TOKEN" 2>/dev/null || echo "‚ö†Ô∏è Failed to add $key"
            fi
          done
          
          echo "‚úÖ Sync to Production complete"
      
      - name: Clean up
        if: always()
        run: |
          rm -f doppler_secrets.json
          echo "‚úÖ Cleaned up temporary files"
      
      - name: Notify completion
        run: |
          echo "üéâ Doppler ‚Üí Vercel sync completed successfully!"
          echo "All 48 secrets synced to Development, Preview, and Production"
