name: Monitor Vercel Deployment

on:
  push:
    branches:
      - main
      - staging
      - develop
  workflow_dispatch:

jobs:
  monitor-deployment:
    name: Monitor Vercel Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Wait for Vercel deployment to start
        run: |
          echo "‚è≥ Waiting 30s for Vercel to pick up the commit..."
          sleep 30

      - name: Monitor Vercel deployment
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          echo "üîç Monitoring Vercel deployment status..."
          node scripts/monitor-vercel-deployment.js --watch

      - name: Deployment Status Check
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ Deployment completed successfully"
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number || context.payload.pull_request?.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Vercel deployment failed. Check the [deployment logs](https://vercel.com/dashboard) for details.'
            })
